# 📂 9장 컬렉션

## 목차
- 01_개요.md
- 02_불변컬렉션.md
- 03_불변컬렉션_예시.md
- 04_스레드안전컬렉션.md
- 05_스레드안전_예시.md
- 06_생산자소비자컬렉션.md
- 07_Channel_예시.md
- 08_스로틀링.md
- 09_샘플링.md
- 10_NuGet_요약.md
- 11_결론.md

---

# 📌 동시성 컬렉션 개요

- 동시성 프로그래밍에서 컬렉션 선택은 성능과 안정성에 큰 영향
- C#은 다양한 동시성 친화 컬렉션을 제공  
  - 불변 컬렉션
  - 스레드 안전 컬렉션
  - 생산자/소비자 컬렉션

---

## 🧩 불변 컬렉션 (Immutable Collections)

### ✅ 특징
- 컬렉션 인스턴스는 절대 변경되지 않음
- 쓰기 작업 시 새로운 인스턴스 반환
- 스레드 안전
- 메모리 공유로 효율적

### 🔧 주요 타입
- `ImmutableStack<T>`, `ImmutableQueue<T>`
- `ImmutableList<T>`
- `ImmutableHashSet<T>`, `ImmutableSortedSet<T>`
- `ImmutableDictionary<TKey, TValue>`, `ImmutableSortedDictionary<TKey, TValue>`

### 📦 NuGet
- `System.Collections.Immutable`

### 🧪 예시

```csharp
var stack = ImmutableStack<int>.Empty;
stack = stack.Push(13).Push(7);
foreach (var item in stack)
    Console.WriteLine(item); // 7, 13
```
- Push, Pop은 새로운 인스턴스를 반환
- 참조 변수는 스레드 안전하지 않음

---

## 🔐 스레드 안전 컬렉션

### ✅ 특징
- 여러 스레드에서 동시에 읽기/쓰기 가능
- 세분화된 잠금 또는 lock-free 기술 사용
- 열거 시 스냅샷 생성

### 🔧 주요 타입
- `ConcurrentDictionary<TKey, TValue>`
- `ConcurrentQueue<T>`, `ConcurrentStack<T>`, `ConcurrentBag<T>`

### 🧪 예시

```csharp
var dict = new ConcurrentDictionary<int, string>();
dict.AddOrUpdate(0, key => "Zero", (key, old) => "Zero");
```
- AddOrUpdate는 델리게이트를 여러 번 호출할 수 있음
- 연산은 스레드 안전하지만 원자적이지 않음

---

## 🔄 생산자/소비자 컬렉션

### ✅ 목적
- 생산자와 소비자 간 데이터 전달
- 항목 수 제한 가능
- 동기/비동기 API 지원

### 🔧 주요 API
- `Channel<T>`
- `BlockingCollection<T>`
- `BufferBlock<T>`
- `AsyncProducerConsumerQueue<T>`

### 🧪 Channel 예시

```csharp
var channel = Channel.CreateUnbounded<int>();
await channel.Writer.WriteAsync(7);
await foreach (var item in channel.Reader.ReadAllAsync())
    Console.WriteLine(item);
```
- WriteAsync, ReadAllAsync로 비동기 처리
- Complete()로 종료 알림 가능

---

## ⚙️ 스로틀링 (Throttling)
- 생산자가 너무 빠를 경우 메모리 압박 방지
- `BoundedChannelOptions` 또는 `BoundedCapacity` 설정

```csharp
var channel = Channel.CreateBounded<int>(new BoundedChannelOptions(1) {
    FullMode = BoundedChannelFullMode.Wait
});
```

---

## ⚙️ 샘플링 (Sampling)
- 오래된 항목 제거: `DropOldest`
- 새 항목 무시: `DropWrite`

```csharp
var channel = Channel.CreateBounded<int>(new BoundedChannelOptions(1) {
    FullMode = BoundedChannelFullMode.DropOldest
});
```

---

## 📚 NuGet 패키지 요약

| 기능 | 패키지 이름 |
|------|-------------|
| 불변 컬렉션 | `System.Collections.Immutable` |
| 채널 | `System.Threading.Channels` |
| 데이터플로우 | `System.Threading.Tasks.Dataflow` |
| AsyncEx | `Nito.AsyncEx` |

---

## 🧠 결론 및 선택 가이드

| 상황 | 추천 컬렉션 |
|------|-------------|
| 상태 공유 | 불변 컬렉션 |
| 동시 접근 | 스레드 안전 컬렉션 |
| 스레드 간 통신 | 생산자/소비자 컬렉션 |
| 고성능 비동기 처리 | Channel, BufferBlock |
| 스냅샷/Undo 기능 | ImmutableStack, ImmutableList |
# 9장 컬렉션 - 개요

## 동시성 컬렉션의 필요성

멀티스레드 환경에서 여러 스레드가 동시에 컬렉션에 접근할 때, 일반적인 컬렉션들(`List<T>`, `Dictionary<TKey, TValue>` 등)은 스레드 안전하지 않습니다. 이로 인해 다음과 같은 문제들이 발생할 수 있습니다:

- **데이터 경합(Race Condition)**: 여러 스레드가 동시에 컬렉션을 수정할 때 예측 불가능한 결과
- **메모리 손상**: 내부 데이터 구조가 일관성 없는 상태가 될 수 있음
- **예외 발생**: `InvalidOperationException`, `IndexOutOfRangeException` 등
- **데이터 손실**: 일부 요소가 누락되거나 중복될 수 있음

## 동시성 컬렉션의 주요 유형

C#에서는 멀티스레드 환경을 위한 세 가지 주요 컬렉션 유형을 제공합니다:

### 1. 불변 컬렉션 (Immutable Collections)
- **특징**: 한 번 생성되면 수정할 수 없음
- **장점**: 스레드 안전성이 보장됨, 부작용 없음
- **용도**: 읽기 중심의 시나리오, 함수형 프로그래밍
- **주요 타입**: `ImmutableList<T>`, `ImmutableDictionary<TKey, TValue>` 등

### 2. 스레드 안전 컬렉션 (Thread-Safe Collections)
- **특징**: 내부적으로 동기화 메커니즘을 사용하여 스레드 안전성 보장
- **장점**: 일반 컬렉션과 유사한 API, 높은 성능
- **용도**: 읽기/쓰기가 모두 필요한 멀티스레드 시나리오
- **주요 타입**: `ConcurrentDictionary<TKey, TValue>`, `ConcurrentBag<T>` 등

### 3. 생산자/소비자 컬렉션 (Producer/Consumer Collections)
- **특징**: 생산자-소비자 패턴에 최적화된 컬렉션
- **장점**: 비동기 처리, 백프레셔 제어, 완료 신호
- **용도**: 작업 대기열, 데이터 파이프라인
- **주요 타입**: `Channel<T>`, `BlockingCollection<T>` 등

## 성능 고려사항

### 읽기 중심 vs 쓰기 중심
- **읽기 중심**: 불변 컬렉션이 가장 효율적
- **쓰기 중심**: 스레드 안전 컬렉션이 더 적합
- **혼합**: 사용 패턴에 따라 선택

### 메모리 사용량
- **불변 컬렉션**: 구조적 공유로 메모리 효율성 향상
- **스레드 안전 컬렉션**: 일반 컬렉션과 유사한 메모리 사용량
- **생산자/소비자 컬렉션**: 버퍼링으로 인한 추가 메모리 사용

### 확장성
- **Lock-free 알고리즘**: 더 나은 확장성 제공
- **세밀한 잠금**: 경합 감소
- **비동기 패턴**: CPU 활용도 향상

## 선택 가이드

| 시나리오 | 권장 컬렉션 유형 | 이유 |
|---------|----------------|------|
| 읽기 전용 데이터 | 불변 컬렉션 | 완전한 스레드 안전성, 부작용 없음 |
| 빈번한 읽기/쓰기 | 스레드 안전 컬렉션 | 높은 성능, 유연성 |
| 비동기 처리 | 생산자/소비자 컬렉션 | 백프레셔 제어, 완료 신호 |
| 캐시 구현 | `ConcurrentDictionary` | 원자적 업데이트, 높은 성능 |
| 작업 대기열 | `Channel` 또는 `BlockingCollection` | 비동기 지원, 완료 신호 |

이 장에서는 각 컬렉션 유형의 특징과 사용법을 자세히 살펴보고, 실제 코드 예시를 통해 효과적인 활용 방법을 알아보겠습니다.